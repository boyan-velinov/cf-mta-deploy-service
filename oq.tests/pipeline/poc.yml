---
jobs:
- name: build-docker-image
#  public: true
  serial: true
  plan:
  - get: oq-tests-git-repo
    trigger: true
  - task: create-timestamp
    config:
      platform: linux
      image_resource:
        type: docker-image
        source: {repository: ubuntu}
      run:
        path: 'bash'
        args: ["oq-test-git-repo/oq.tests/pipeline/generate_timestamp.sh","ts/tag"]
      inputs:
      - name: oq-tests-git-repo
        path: "oq-test-git-repo"
      outputs:
      - name: timestamp
        path: "ts"
  - put: test-environment-image
    params:
      build: oq-tests-git-repo/oq.tests/container
      tag: timestamp/tag
- name: run-test
  plan:
  - get: test-environment-image
    trigger: true
  - task: test-substep-1
    image: test-environment-image
    config:
      platform: linux
      run:
        path: 'cf'
        args: ["plugins"]

resources:
- name: oq-tests-git-repo
  type: git
  source:
    uri: https://github.com/ddonchev/cf-mta-deploy-service.git
    branch: oq_poc
    skip_ssl_verification: true

- name: test-environment-image
  type: docker-image
  source:
     repository: 192.168.100.4:5000/mta-test-image
     insecure_registries: [ "192.168.100.4:5000" ]
